apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: bankcore-metrics
  namespace: banking-prod
  labels:
    app: bankcore
    prometheus: kube-prometheus
spec:
  selector:
    matchLabels:
      app: bankcore
      component: backend
  endpoints:
  - port: http
    path: /actuator/prometheus
    interval: 30s
    scrapeTimeout: 10s
    honorLabels: true
    relabelings:
    - sourceLabels: [__meta_kubernetes_pod_name]
      targetLabel: pod
    - sourceLabels: [__meta_kubernetes_pod_node_name]
      targetLabel: node
    - sourceLabels: [__meta_kubernetes_namespace]
      targetLabel: namespace
    - sourceLabels: [__meta_kubernetes_pod_label_version]
      targetLabel: version
---
apiVersion: monitoring.coreos.com/v1
kind: PrometheusRule
metadata:
  name: bankcore-alerts
  namespace: banking-prod
  labels:
    app: bankcore
    prometheus: kube-prometheus
spec:
  groups:
  - name: bankcore.rules
    interval: 30s
    rules:
    # High error rate
    - alert: HighErrorRate
      expr: |
        (
          sum(rate(http_server_requests_seconds_count{namespace="banking-prod",app="bankcore",status=~"5.."}[5m]))
          /
          sum(rate(http_server_requests_seconds_count{namespace="banking-prod",app="bankcore"}[5m]))
        ) > 0.05
      for: 5m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "High error rate detected for demo"
        description: "Error rate is {{ $value | humanizePercentage }} for demo application"
        runbook_url: "https://wiki.company.com/runbooks/bankcore-errors"
    
    # Pod not ready
    - alert: PodNotReady
      expr: |
        kube_pod_status_ready{namespace="banking-prod", pod=~"bankcore.*", condition="true"} == 0
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "Pod {{ $labels.pod }} is not ready"
        description: "Pod {{ $labels.pod }} in namespace {{ $labels.namespace }} has been not ready for more than 5 minutes"
    
    # High response time
    - alert: HighResponseTime
      expr: |
        histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket{namespace="banking-prod",app="bankcore"}[5m])) by (le)) > 1
      for: 10m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "High response time for demo"
        description: "95th percentile response time is {{ $value }}s"
    
    # High memory usage
    - alert: HighMemoryUsage
      expr: |
        (
          sum(container_memory_working_set_bytes{namespace="banking-prod", pod=~"bankcore.*"}) by (pod)
          /
          sum(container_spec_memory_limit_bytes{namespace="banking-prod", pod=~"bankcore.*"}) by (pod)
        ) > 0.9
      for: 5m
      labels:
        severity: warning
        team: platform
      annotations:
        summary: "High memory usage for pod {{ $labels.pod }}"
        description: "Memory usage is {{ $value | humanizePercentage }} of limit"
    
    # Too few pods running
    - alert: InsufficientReplicas
      expr: |
        kube_deployment_status_replicas_available{namespace="banking-prod", deployment="bankcore"} < 2
      for: 5m
      labels:
        severity: critical
        team: platform
      annotations:
        summary: "Insufficient replicas for demo"
        description: "Only {{ $value }} replicas are running, minimum 2 required for HA"